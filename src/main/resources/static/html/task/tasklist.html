<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <!--<div style="padding:5px;background:#fafafa;width:100%;border:1px solid #ccc">-->
        <!--<a href="javascript: openPage('添加任务', 'html/task/taskplan.html');" class="easyui-linkbutton" plain="true" iconCls="icon-add">添加</a>-->
    <!--</div>-->

    <div id="toolbar">
        <a href="#" class="easyui-linkbutton" iconCls="icon-reload" plain="true" onclick="reloadTask();">刷新</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="openPage('添加任务', 'html/task/taskplan.html')">新建</a>
    </div>

    <table id="taskGrid" class="easyui-datagrid" data-options="url:'/task',method: 'get', fitColumns:true">
        <thead>
        <tr>
            <th data-options="field:'name', width: '100px'">名称</th>
            <th data-options="field:'type',width: '100px', formatter: convTaskType">类型</th>
            <th data-options="field:'cronExpress',width: '100px'">cron表达式</th>
            <th data-options="field:'detail',width: '100px', formatter: editTask">操作</th>
        </tr>
        </thead>
    </table>


    <div id="taskWin" class="easyui-window" title="My Window" closed="true" style="width:800px;height:600px;padding:5px;">
        <table cellpadding="5" width="100%">
            <tr>
                <td width="100px">任务名称:</td>
                <td id="taskName"></td>
            </tr>
            <tr>
                <td>任务类型:</td>
                <td id="taskType"></td>
            </tr>
            <tr id="cronTr" style="visibility: hidden">
                <td>cron表达式:</td>
                <td id="cronExpress"></td>
            </tr>
            <tr>
                <td>任务内容:</td>
                <td>
                    <textarea id="taskDetail" style="width: 100%; height: 400px"></textarea>
                </td>
            </tr>
        </table>
    </div>

    <script>

        function openTaskWin(id) {
            $("#taskName").html("");
            $("#taskType").html("");
            $("#cronExpress").html("");
            $("#taskDetail").html("");

            $.get("/task/" + id).then(function(task) {
                $("#taskName").html(task.name);

                if (task.type == 1) {
                    $("#cronTr").css("visibility", "hidden");
                    $("#taskType").html("手工任务");
                } else if (task.type == 2) {
                    $("#taskType").html("定时任务");
                    $("#cronTr").css("visibility", "visible");
                    $("#cronExpress").html(task.cronExpress);
                }
                $("#taskDetail").html(task.detail);
                $("#taskWin").window('open');
            });
        }


        function reloadTask() {
            $("#taskGrid").datagrid('reload');
        }

        function editTask(value, row, index) {
            var html = '<div id="toolbar">';
            html = html + '<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="executeTask('+row.id+');">执行任务</a>&nbsp';
            html = html + '<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="openPage(\'编辑任务\', \'/task/toEditTask/'+ row.id +'\')">编辑任务</a>&nbsp';
            html = html + '<a href="#"  class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="deleteTask('+row.id+');">删除</a>&nbsp;';
            html = html + '<a href="#"  class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="openTaskWin('+row.id + ');">详情</a>&nbsp;';
            html = html+ '</div>';
            return html;
        }

        function deleteTask(id) {

            $.ajax({
                method: 'DELETE',
                url: '/task/'+id,
                success: function() {
                    reloadTask();
                    $.messager.show(
                        {
                            title: '消息',
                            msg: '删除任务成功',
                            showType: 'fade',
                            style:{
                                right:'',
                                bottom:''
                            }
                        });
                }
            })
        }

        function executeTask(id) {
            $.ajax({
                method: 'POST',
                url: '/task/execute/'+id,
                success: function() {
                    $.messager.show(
                        {
                            title: '消息',
                            msg: '任务已经在后台执行',
                            showType: 'fade',
                            style:{
                                right:'',
                                bottom:''
                            }
                        });
                }
            })
        }

    </script>





</body>
</html>